<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>The Basics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="/javascripts/all.js" type="text/javascript"></script>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', "UA-34296486-1"]);


  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head>

  
  

  <body class="docs docs_basics">
    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          <header>
            <h1>
              <a href="/">Sky</a>
              <br class="visible-phone"/>
              <small><span class="hidden-phone">Open Source, </span>Behavioral Database</small>
            </h1>
          </header>

          <ul class="nav nav-pills">
            <li class="">
              <a href="/">Home</a>
            </li>
            <li class="active">
              <a href="/docs">
                <span class="hidden-phone">Documentation</span>
                <span class="visible-phone">Docs</span>
              </a>
            </li>
            <li class="">
              <a href="/blog">Blog</a>
            </li>
            <li><a class="disable hidden-phone" href="/sky-0.2.1.tar.gz">Download</a></li>
            <li>
              <a href="https://github.com/skydb/sky">
                <span class="hidden-phone">Repository</span>
                <span class="visible-phone">Repo</span>
              </a>
            </li>
          </ul>

          <hr class="soften">
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          
            <h2>The Basics</h2>
          
          <h3>Collecting Events</h3>

<p>The Sky client library is simple.
You can store events and you can aggregate the events.
To store an event using the Ruby library simply call <code>add_event()</code>:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;customers&#39;</span>

<span class="no">SkyDB</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
  <span class="kp">new</span> <span class="no">Event</span><span class="p">(</span>
    <span class="ss">:object_id</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
    <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
    <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;purchase&#39;</span><span class="p">,</span>
      <span class="ss">:purchase_amount</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="o">.</span><span class="mi">95</span><span class="p">,</span>
      <span class="ss">:referrer_url</span> <span class="o">=&gt;</span> <span class="s1">&#39;google.com&#39;</span>
    <span class="p">},</span>
    <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
      <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
      <span class="ss">:rewards_member</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">)</span>
</pre></div>
<p>In this example, we&#39;re tracking a purchase just made by <code>John Doe</code> who&#39;s customer id is <code>10</code> in our database.
The <code>object_id</code> can be any number but typically it is the primary key from your production database table.
The <code>action</code> object shows that this is a <code>purchase</code> for $9.95 and the customer was referred from Google.
The <code>name</code> is the only action field required.
The other action properties will be added automatically if they don&#39;t already exist.</p>

<p>The <code>data</code> object tracks information specifically about our customer. 
This customer&#39;s name is <code>John Doe</code> and he is currently a rewards member.
Sky is smart about saving this data so if Sky already knew that this customer&#39;s name was John Doe at this point in time then it wouldn&#39;t save it again.
However, if Sky detects that this customer was previously not a rewards member then Sky will store the <code>rewards_member</code> property value for this customer at this point in time.
Sky only saves the data deltas for object properties.</p>

<h3>Property Types</h3>

<p>Each property on a table has a data type and is marked as being an action property or an object property.
Object properties will maintain their state over time whereas the value of action properties only exist at the time of the action.</p>

<p>The following property data types exist:</p>

<ul>
<li>String</li>
<li>Integer</li>
<li>Double</li>
<li>Boolean</li>
</ul>

<p>When you add an event with a property that doesn&#39;t exist, Sky will automatically add it and set it&#39;s property data type based on the value provided.
If you&#39;d like more control over properties and actions, you can use the <code>add_action()</code> and <code>add_property()</code> methods on the <code>SkyDB</code> object.</p>

<h3>Aggregating Data</h3>

<p>Once you have events in your database you can aggregate them using the handy Lua aggregation framework.
<a href="http://www.lua.org/">Lua</a> is a simple, embeddable language that is compiled and optimized into machine code on the fly making it extremely fast.</p>

<p>In this example, we&#39;ll start with something simple.
We&#39;ll aggregate the total number of purchases and the total amount of purchases.
We can pass this script into <code>SkyDB.aggregate()</code> and the contents of the <code>data</code> variable will be passed back to Ruby:</p>
<div class="highlight"><pre><span class="k">function</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="n">event</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">:</span><span class="n">event</span><span class="p">()</span>
  <span class="n">data</span><span class="p">.</span><span class="n">purchase_amount</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">purchase_amount</span> <span class="ow">or</span> <span class="mi">0</span>
  <span class="n">data</span><span class="p">.</span><span class="n">purchase_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">purchase_count</span> <span class="ow">or</span> <span class="mi">0</span>

  <span class="k">while</span> <span class="n">cursor</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span> <span class="k">do</span>
    <span class="c1">-- The &#39;purchase&#39; action id needs to be retrieved before generating the script.</span>
    <span class="c1">-- Let&#39;s assume that we know it is &#39;2&#39;.</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">action_id</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">then</span>
      <span class="n">data</span><span class="p">.</span><span class="n">purchase_amount</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">purchase_amount</span> <span class="o">+</span> <span class="n">event</span><span class="p">.</span><span class="n">purchase_amount</span>
      <span class="n">data</span><span class="p">.</span><span class="n">purchase_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">purchase_count</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>In this example, our <code>aggregate()</code> function will retrieve a <code>cursor</code> for each object in the table.
The <code>data</code> object passed in is a Lua table that lets us store a hash of data.
Here we are storing the total purchase amount and the total number of purchases.</p>

<p>Next, we loop over the cursor.
Each time we loop in the cursor we get the next event for an object so we can process the full history of state and actions for an object.
In this example, we&#39;re hard coding the action identifier for the <code>purchase</code> action.
In your application you would typically look this up and insert it into the Lua script.
If so, we&#39;ll add the purchase amount to the total and we&#39;ll increment our counter on the <code>data</code> object.</p>

<p>The <code>data</code> variable can be structured however you want.
The variable will be serialized into MessagePack format so that it can be sent to Ruby in the same format.</p>

<p>In the next section, we&#39;ll talk more in detail about how Lua integrates with Sky.</p>

<p><br/>
<a href="architecture.html">« Prev <span class="hidden-phone">(The Sky Architecture)</span></a>
<span class="pull-right"><a href="lua.html">Next <span class="hidden-phone">(Data Processing Using Lua)</span> »</a></span></p>

        </div>
      </div>
    </div><!-- /container -->
    
    
    
    <footer>
    </footer>
  </body>
</html>
