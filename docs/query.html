<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Behavioral Query Language</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="/javascripts/all.js" type="text/javascript"></script>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', "UA-34296486-1"]);


  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head>

  
  

  <body class="docs docs_query">
    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          <header>
            <h1>
              <a href="/">Sky</a>
              <br class="visible-phone"/>
              <small><span class="hidden-phone">Open Source, </span>Behavioral Database</small>
            </h1>
          </header>

          <ul class="nav nav-pills">
            <li class="">
              <a href="/">Home</a>
            </li>
            <li><a class="disable hidden-phone" href="http://demo.skydb.io">Demo</a></li>
            <li class="active">
              <a href="/docs">
                <span class="hidden-phone">Documentation</span>
                <span class="visible-phone">Docs</span>
              </a>
            </li>
            <li class="">
              <a href="/blog">Blog</a>
            </li>
            <li><a class="disable hidden-phone" href="/sky-0.2.3.tar.gz">Download</a></li>
            <li>
              <a href="https://github.com/skydb/sky">
                <span class="hidden-phone">Repository</span>
                <span class="visible-phone">Repo</span>
              </a>
            </li>
          </ul>

          <hr class="soften">
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          
            <h2>Behavioral Query Language</h2>
          
          <h3>Overview</h3>

<p>The Sky query system is conceptually similar to SQL and includes selection, grouping and conditional sections.
However, SQL is meant to be used on relational data and Sky&#39;s query system works on behavioral data.
Because of this you also get temporal operators like <code>after()</code> that relate the relationship between actions.</p>

<p>Another important note is that the query engine is built into the Sky Ruby gem and built on top of the dynamic Lua execution available in the Sky server.
You can see the generated Lua at any time by running the <code>codegen()</code> method of the <code>SkyDB::Query</code> object.</p>

<h3>Selection</h3>

<p>The most basic Sky query is a simple select.
Within the select you get a choice of aggregation types:</p>

<ul>
<li><code>count()</code></li>
<li><code>sum(property)</code></li>
<li><code>min(property)</code></li>
<li><code>max(property)</code></li>
</ul>

<p>For example, you could count the total number of events in your database with this query:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="c1">#=&gt; {count:82392}</span>
</pre></div>
<p>You can also alias fields to change the returned name:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count() my_count, sum(purchase_amount)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="c1">#=&gt; {my_count:82392, purchase_amount:13982.02}</span>
</pre></div>
<h3>Grouping</h3>

<p>Selection is useful for aggregating the data, however, it doesn&#39;t help unless you can segment the data.
To do this, you can use the <code>group_by()</code> method on the query object.
These helper methods all return the query object so you can chain them together.</p>

<p>Here&#39;s an example of counting the number of each type of action in your system:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="c1">#=&gt; {1:{count:29301}, 2:{count:9123}}</span>
</pre></div>
<p>The <code>group_by</code> method accepts multiple levels of grouping and multiple forms.
The following are all equal:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;utm_source, action_id&quot;</span><span class="p">)</span>
<span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;utm_source&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span>
<span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="ss">:utm_source</span><span class="p">,</span> <span class="ss">:action_id</span><span class="p">)</span>
</pre></div>
<h3>After Condition</h3>

<p>The &#39;after&#39; condition is a powerful tool.
It lets you select from the event immediately following an action.
For example, if you&#39;re tracking page views on a web site and you want to see what page people went to immediately after visiting the <code>/index.html</code> page, you can write the following query:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/index.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
<p>You can chain together <code>after()</code> calls to make a funnel analysis:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/index.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/signup.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/welcome.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
<p>This query will show what people did immediately after viewing the home page, signing up on the web site and then being presented with a welcome message after sign up.
Each successive <code>after()</code> condition will search all actions after the previous one until a match is found within the current session.</p>

<p>The <code>select()</code> will only occur once all the <code>after()</code> conditions have been fulfilled.
That means that if a user only goes to <code>/index.html</code> and <code>/signup.html</code> but never goes to <code>/welcome.html</code>, they will not be counted.</p>

<h3>Sessions</h3>

<p>Usually you will want to perform something like funnel analysis within the context of a session.
A session can be defined by the number of idle seconds that must occur between actions that causes one session to stop and another one to start.
You can set the session idle time by using the <code>Query.session()</code> method:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/index.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/signup.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="s2">&quot;/welcome.html&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="mi">7200</span><span class="p">)</span>             <span class="c1"># Sets a 2-hour idle time between sessions.</span>
     <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
<p>There are two important features of sessions.
First, you can use <code>after(:enter)</code> to track the start of the session:</p>
<div class="highlight"><pre><span class="no">SkyDB</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;count()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;action_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="ss">:enter</span><span class="p">)</span>
</pre></div>
<p>This shows the number of actions performed immediately upon starting a session.</p>

<p>The other feature is that you can see where people dropped off of a session.
In our sessionized funnel analysis above, you&#39;ll see action identifiers of <code>-1</code> returned.
The <code>-1</code> action id represents a selection where all the <code>after</code> conditions matched but the session is at the end.</p>

<p>In the next section, we&#39;ll talk about how to bulk load data into Sky so you can start using your own data set.</p>

<p><br/>
<a href="basics.html">« Prev <span class="hidden-phone">(The Basics)</span></a>
<span class="pull-right"><a href="import.html">Next <span class="hidden-phone">(Bulk Importing Data)</span> »</a></span></p>

        </div>
      </div>
    </div><!-- /container -->
    
    
    
    <footer>
    </footer>
  </body>
</html>
