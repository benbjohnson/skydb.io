<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Data Processing Using Lua</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="/javascripts/all.js" type="text/javascript"></script>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', "UA-34296486-1"]);


  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head>

  
  

  <body class="docs docs_lua">
    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          <header>
            <h1>
              <a href="/">Sky</a>
              <br class="visible-phone"/>
              <small><span class="hidden-phone">Open Source, </span>Behavioral Database</small>
            </h1>
          </header>

          <ul class="nav nav-pills">
            <li class="">
              <a href="/">Home</a>
            </li>
            <li class="active">
              <a href="/docs">
                <span class="hidden-phone">Documentation</span>
                <span class="visible-phone">Docs</span>
              </a>
            </li>
            <li class="">
              <a href="/blog">Blog</a>
            </li>
            <li><a class="disable hidden-phone" href="/sky-0.2.1.tar.gz">Download</a></li>
            <li>
              <a href="https://github.com/skydb/sky">
                <span class="hidden-phone">Repository</span>
                <span class="visible-phone">Repo</span>
              </a>
            </li>
          </ul>

          <hr class="soften">
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          
            <h2>Data Processing Using Lua</h2>
          
          <h3>How Lua Fits into Sky</h3>

<p>In the last section we looked at a simple aggregation program in Lua that computes our total number of purchases and the total amount spent.
In this section we&#39;ll look at how Sky integrates with Lua at a lower level.
Sky is built to be simple.
It stores events and reads them back in order.
Lua was added to flexibly handle any analytical complexity you want to throw at it.</p>

<p>This documentation won&#39;t cover how to code in Lua.
For an introduction to <a href="http://www.lua.org/">Lua</a>, you can find resources on the <a href="http://www.lua.org/docs.html">Lua documentation</a> page.
You can also read up on <a href="http://luajit.org/">LuaJIT</a> to understand how to load and call C functions or to optimize your Lua code.</p>

<h3>The Basic Structure</h3>

<p>The basic Lua aggregation program looks like this:</p>
<div class="highlight"><pre><span class="k">function</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
  <span class="c1">-- Initialize your own data structures here. Also, grab a reference to</span>
  <span class="c1">-- the current event state. The event&#39;s property values will change on</span>
  <span class="c1">-- each iteration below but it&#39;s reference stays the same.</span>
  <span class="n">event</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">:</span><span class="n">event</span><span class="p">()</span>

  <span class="c1">-- Loop over every event that occurred with the object.</span>
  <span class="k">while</span> <span class="n">cursor</span><span class="p">:</span><span class="nb">next</span><span class="p">()</span> <span class="k">do</span>
    <span class="c1">-- Do something with the current event data.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<h3>Breaking It Down</h3>

<p>It might look complicated at first but it&#39;s fairly intuitive once you dive in.
The <code>aggregate()</code> function starts by providing you a <code>cursor</code> argument and a <code>data</code> argument.
This function gets called once for every object in your table.
The <code>cursor</code> lets you chronologically iterate over each event that belongs to the object.</p>

<p>To access the current state of the object, use the <code>event</code> variable.
You can access object and action properties by name.
For example, if you had an <code>age</code> property on your table you can access it for the current object within the current event by using <code>event.age</code>.
The action identifier can be found by using <code>event.action_id</code> and the timestamp of the event is <code>event.timestamp</code>.
Timestamps are stored as seconds since midnight, January 1, 1970 UTC.</p>

<p>To move to the next event in the object, you just need to call the <code>next()</code> method on the <code>cursor</code>.
When there are no more events then the loop will stop and the function will exit.</p>

<p><em>Important Note:</em> Strings are treated differently.
See the &ldquo;Gotchas&rdquo; section below to learn how to use them.</p>

<h3>Where The Data Goes</h3>

<p>Once all the data is aggregated it is returned to Ruby.
You can structure your Lua data structures however you want and they&#39;ll be encoded in MessagePack so your Ruby structure will look identical.
So if your Lua data is a hash of hashes then your Ruby data will be a hash of hashes.</p>

<p>One caveat is that Lua doesn&#39;t have a separate concept of hashes and arrays &ndash; Lua just has <em>tables</em>.
Because of this and because consistency is important, all tables are encoded as hashes.</p>

<h3>Gotchas</h3>

<p>Processing using Sky and Lua works about how you&#39;d expect it to.
There are some things to remember though:</p>

<ol>
<li><p>Don&#39;t write to any global variables!
The Lua script is executed in multiple contexts so globals won&#39;t be consistent.
One exception is if you have read-only global data.
That&#39;s fine.</p></li>
<li><p>The <code>event</code> object returned by <code>cursor:event()</code> doesn&#39;t change &ndash; only it&#39;s properties do.
That means that you can copy properties from the <code>event</code> object but you can&#39;t save a copy of the whole object.</p></li>
<li><p>String properties are treated differently than integers, booleans and floats.
To use a string, you need to use a wrapper function.
That means instead of calling <code>event.first_name</code> you need to use <code>event:first_name()</code>.
Note the colon instead of a dot and the parentheses at the end.</p></li>
</ol>

<h3>LuaJIT API</h3>

<p>Sky uses LuaJIT to compile Lua into machine code at runtime.
It also allows you to extend the Lua language by using C structs for performance and using an FFI interface to work with C libraries.
However, use this at your own risk!
Sky doesn&#39;t have any way to catch memory access errors or problems in external libraries.
That means that LuaJIT can crash Sky if used improperly.</p>

<p>You can learn more about this technique by referencing the <a href="http://luajit.org/ext_ffi.html">LuaJIT FFI reference</a>.</p>

<p><br/>
<a href="basics.html">« Prev <span class="hidden-phone">(The Basics)</span></a>
<span class="pull-right"><a href="sessions.html">Next <span class="hidden-phone">(Aggregating Sessions)</span> »</a></span></p>

        </div>
      </div>
    </div><!-- /container -->
    
    
    
    <footer>
    </footer>
  </body>
</html>
