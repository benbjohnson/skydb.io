<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Data Processing Using Lua</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="/javascripts/all.js" type="text/javascript"></script>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', "UA-34296486-1"]);


  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head>

  
  

  <body class="docs docs_lua">
    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          <header>
            <h1>
              <a href="/">Sky</a>
              <br class="visible-phone"/>
              <small><span class="hidden-phone">Open Source, </span>Behavioral Database</small>
            </h1>
          </header>

          <ul class="nav nav-pills">
            <li class="">
              <a href="/">Home</a>
            </li>
            <li class="active">
              <a href="/docs">
                <span class="hidden-phone">Documentation</span>
                <span class="visible-phone">Docs</span>
              </a>
            </li>
            <li class="">
              <a href="/blog.html">Blog</a>
            </li>
            <li><a class="disable hidden-phone" href="https://github.com/skydb/sky/downloads">Download</a></li>
            <li>
              <a href="https://github.com/skydb/sky">
                <span class="hidden-phone">Repository</span>
                <span class="visible-phone">Repo</span>
              </a>
            </li>
          </ul>

          <hr class="soften">
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          
            <h2>Data Processing Using Lua</h2>
          
          <h3 id='how_lua_fits_into_sky'>How Lua Fits into Sky</h3>

<p>In the last section we looked at a simple map/reduce program in Lua that computes our total number of purchases and the total amount spent. In this section we&#8217;ll look at how Sky integrates with Lua at a lower level. Sky is built to be simple. It stores events and reads them back in order. Lua was added to flexibly handle any analytical complexity you want to throw at it.</p>

<p>This documentation won&#8217;t cover how to code in Lua. For an introduction to <a href='http://www.lua.org/'>Lua</a>, you can find resources on the <a href='http://www.lua.org/docs.html'>Lua documentation</a> page. You can also read up on <a href='http://luajit.org/'>LuaJIT</a> to understand how to load and call C functions or to optimize your Lua code.</p>

<h3 id='the_basic_structure'>The Basic Structure</h3>

<p>The basic Lua map/reduce program looks like this:</p>

<pre><code>function map(cursor, data)
  -- Initialization for each object belongs here.
  
  while not cursor:eof() do
    event = cursor:event()

    -- Do something with the event.
    
    cursor:next()
  end
end

function reduce(results, data)
  -- Combine the data argument into the results argument here.
  return results
end</code></pre>

<h3 id='start_with_map'>Start With map()</h3>

<p>It might look complicated at first but it&#8217;s fairly intuitive once you dive in. The <code>map()</code> function starts by providing you a <code>cursor</code> argument and a <code>data</code> argument. This function gets called once for every object in your table. The <code>cursor</code> lets you chronologically iterate over each event that belongs to the object.</p>

<p>To access the current state of the object, use the <code>event</code> variable. You can access object and action properties by name. For example, if you had a <code>first_name</code> property on your table you can access it for the current object within the current event by using <code>event.first_name</code>. The action identifier can be found by using <code>event.action_id</code> and the timestamp of the event is <code>event.timestamp</code>. Timestamps are stored as microseconds since midnight, January 1, 1970 UTC.</p>

<p>To move to the next event in the object, you just need to call the <code>next()</code> method on the <code>cursor</code>. When there are no more events then the cursor&#8217;s <code>eof()</code> function will return <code>false</code>.</p>

<h3 id='finish_with_reduce'>Finish With reduce()</h3>

<p>Finally, the <code>reduce()</code> function will be called to combine groups of <code>map()</code> calls together. The map functions are grouped together in the background for performance reasons so the reduce function only gets called a few times. The <code>results</code> argument is a Lua table that you can combine the map data into. The <code>data</code> argument is the same as the <code>data</code> argument passed to <code>map()</code>.</p>

<p>Once all the data has been reduced, Sky will MessagePack encode the <code>results</code> variable and send it back to the client. That means that you can structure your results in whatever way you want. One caveat is that since Lua doesn&#8217;t have a separate hash and array construct, MessagePack will encode tables with all numeric keys as arrays. You can add a dummy string key to your table to force it to always be a map.</p>

<h3 id='gotchas'>Gotchas</h3>

<p>Processing using Sky and Lua works about how you&#8217;d expect it to. There are some things to remember though:</p>

<ol>
<li>
<p>Don&#8217;t write to any global variables! The Lua script is executed in multiple contexts so globals won&#8217;t be consistent. One exception is if you have read-only global data. That&#8217;s fine.</p>
</li>

<li>
<p>The <code>event</code> object returned by <code>cursor:event()</code> doesn&#8217;t change &#8211; only it&#8217;s properties do. That means that you can copy properties from the <code>event</code> object but you can&#8217;t save a copy of the whole object.</p>
</li>
</ol>

<h3 id='luajit_api'>LuaJIT API</h3>

<p>Sky uses LuaJIT to compile Lua into machine code at runtime. It also allows you to extend the Lua language by using C structs for performance and using an FFI interface to work with C libraries. However, use this at your own risk! Sky doesn&#8217;t have any way to catch memory access errors or problems in external libraries. That means that LuaJIT can crash Sky if used improperly.</p>

<p>You can learn more about this technique by referencing the <a href='http://luajit.org/ext_ffi.html'>LuaJIT FFI reference</a>.</p>
<br /><a href='basics.html'>Â« Prev <span class='hidden-phone'>(The Basics)</span></a>
        </div>
      </div>
    </div><!-- /container -->
    
    
    
    <footer>
    </footer>
  </body>
</html>
